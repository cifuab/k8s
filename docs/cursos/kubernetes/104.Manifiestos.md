---
title: Kubectl y Manifiestos de Kubernetes
description: Aprende a usar manifiestos en Kubernetes para definir tus recursos y aplicarlos de forma sencilla con kubectl. 
keywords: [kubernetes, manifiestos, pods, yaml, json, kubectl]
sidebar: Manifiestos
image: https://pabpereza.dev/img/banner_kubernetes.png
tags: [kubernetes]
---

# Kubectl y Manifiestos de Kubernetes
En este capítulo vamos a ver como configurar nuestro kubectl para que pueda comunicarse con nuestro cluster de kubernetes y cómo definir manifiestos para poder aplicarlos de forma sencilla.

## Configurar kubectl
En la creación del cluster de kubernetes se nos proporcionó un archivo de configuración que nos permite conectarnos a él. Este se encuentra en el nodo maestro ( o controlplane) en la ruta `/etc/kubernetes/admin.conf`. Para poder usarlo en nuestro equipo local, lo copiaremos a la carpeta `~/.kube/config` de nuestro equipo local.

Kubectl busca por defecto en la carpeta `~/.kube/config` para encontrar la configuración del cluster. Si queremos usar otro archivo de configuración, podemos usar la variable de entorno `KUBECONFIG` para indicarle a kubectl donde buscar.

```shell
export KUBECONFIG=/ruta/al/archivo.conf
```

## Kubeconfig 
Este fichero de configuración, contiene la ruta del API del clúster, el certificado de seguridad, el token de acceso y el contexto de kubectl. 

```yaml
apiVersion: v1
kind: Config
clusters:
- name: mi-cluster
  cluster:
    server: https://192.168.1.100:6443
    certificate-authority: /ruta/ca.crt  # Certificado del clúster
users:
- name: mi-usuario
  user:
    client-certificate: /ruta/client.crt
    client-key: /ruta/client.key
contexts:
- name: mi-contexto
  context:
    cluster: mi-cluster
    user: mi-usuario
current-context: mi-contexto
```


## Kubectl config y contextos
El comando `kubectl config` nos permite gestionar la configuración de kubectl. Algunos comandos útiles son:
* `kubectl config view`: Muestra la configuración actual.
* `kubectl config get-contexts`: Muestra los contextos disponibles.
* `kubectl config use-context <nombre-contexto>`: Cambia el contexto actual.

También podemos añadir nuevos contextos con el comando `kubectl config set-context <nombre-contexto> --cluster=<nombre-cluster> --user=<nombre-usuario>` y no tener que modificar el archivo de configuración manualmente.


## Manifiestos
Por debajo de todas las acciones de kubernetes, lo que el motor entiende, son archivos manifiesto que definen el tipo de cada elemento. Pueden ser escritos en formato yaml o json. Aunque kubernetes los procesa finalmente en formato json, lo más normal para los humanos es escribirlos en yaml. 

Cuando se coge cierta experiencia se dejan de usar comandos para usar manifiestos y poder aplicar varios a la vez, haciendo el proceso menos tedioso.

Además, un manifiesto nos puede servir para versionar la configuración de los recursos de nuestro cluster en un repositorio git, por ejemplo. También, no solo sirven para crearlos, también podemos coger cualquier recursos existente en un cluster y obtener su manifiesto para guardarlo o modificarlo. Esto facilita mucho la gestión de los recursos en un cluster.
![Manifiestos](https://i0.wp.com/blog.nashtechglobal.com/wp-content/uploads/2024/01/kubernetes-manifests.png?fit=1400%2C587&ssl=1)

### ¿Cómo se estructura un manifiesto?
Un manifiesto de kubernetes se compone de 3 partes:
* **apiVersion**: Versión de la API de kubernetes que se va a usar.
* **kind**: Tipo de recurso que se va a definir.
* **metadata**: Información adicional del recurso (nombre, etiquetas, etc).
* **spec**: Especificación del recurso (contenedores, volúmenes, etc).

### Ejemplo de un manifiesto
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: podtest
spec:
  containers:
  - name: cont1
    image: nginx:alpine
```

Esto sería un ejemplo muy sencillo, pero en un manifiesto podemos definir cualquier tipo de recurso de kubernetes, como pods, deployments, services, etc.

### Manifiestos del propio cluster
Estos manifiestos no solo se usan para los componentes que nosotros definimos, también se utilizan para los propios componentes del cluster que vimos en el vídeo de arquitectura.

Por defecto, en un cluster de kubernetes, los manifiestos de los recursos se guardan en `/etc/kubernetes/manifests`.

Lo menciono por curiosidad, evitad tocarlos si no sabéis lo que estáis haciendo, ya que podéis dejar el cluster inutilizable. Esto lo veremos en la parte de CKA para troubleshooting, activar y desactivar componentes del cluster, mejorar la seguridad, etc.


### Definir un pod en un manifiesto
Vamos a ponerlo en práctica.

Creamos la definición de un pod de prueba que escribirá “Hello world” y se quedará en ejecución durante 1 hora.:
```shell
apiVersion: v1
kind: Pod
metadata:
  name: myapp-pod
  labels:
    app: myapp
spec:
  containers:
  - name: myapp-container
    image: busybox
    command: ['sh', '-c', 'echo Hello World!; sleep 3600']
```

Luego podríamos crear el elemento o aplicar cualquier manifiesto con el comando:
```shell
kubectl apply -f <manifiesto.yaml>
```

En nuestro caso, sería:
```shell
kubectl apply -f pod.yaml
```

También podríamos eliminarlo usando el manifiesto con el comando:
```shell
kubectl delete -f pod.yaml
```

### Obtener el manifiesto de un pod
Como ya hemos visto, el motor de kubernetes entiende los manifiestos, por lo que podemos obtener el manifiesto de un recurso que ya existe en el cluster. Para ello, usamos el comando:
```shell
kubectl get pods <nombre pod> -o <formato>
```

Existen varios formatos de salida pero los más comunes son yaml (el usado nativamente por kubernetes), json,  name, go-template (para customizaciones)... [https://kubernetes.io/docs/reference/kubectl/overview/#custom-columns](https://kubernetes.io/docs/reference/kubectl/overview/#custom-columns)


Cuando se obtiene el manifiesto de un recurso, podemos ver mucha más información que en yaml que usamos para crearlo. Kubernetes añade una serie de campos adicionales para guardar el estado del recurso, sus eventos, el nodo en el que se encuentra, etc.

También podríamos aprovechar para editar un recurso de kubernetes directamente con el comando (en este caso específico para el tipo de recurso pod):
```shell
kubectl edit pods <nombre pod>
```

Esto nos permitirá editar el manifiesto del recurso directamente en el editor de texto que tengamos configurado en nuestro sistema.

Finalmente, guardaría los cambios y kubernetes se encargaría de aplicarlos.



## Resumen
Ya iremos profunfizando, con tener claro el funcionamiento general y como configurar kubectl es suficiente para empezar a trabajar con kubernetes.

A lo largo del curso veremos todos los objetos que podemos definir en kubernetes y las distintas etiquetas, atributos y propiedades que podemos usar para definirlos en estos manifiestos. 

---
* Lista de vídeos en Youtube: [Curso Kubernetes](https://www.youtube.com/playlist?list=PLQhxXeq1oc2k9MFcKxqXy5GV4yy7wqSma)

[Volver al índice](README.md#índice)